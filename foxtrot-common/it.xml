<project basedir="." name="test-elasticsearch6-it">
	<property name="it.dir" value="${target.dir}/it"/>
	<property name="es.dir" value="${it.dir}/elasticsearch-${elasticsearch.version}"/>
	<available file="${es.dir}" property="es.dir.exists" type="dir"/>
	<property name="es.pid.file" value="${it.dir}/elasticsearch-${elasticsearch.version}/pid"/>
	<available file="${es.pid.file}" property="es.pid.file.exists" type="file"/>

	<target description="Install Elasticsearch and plugins" name="setup" unless="${es.dir.exists}">
		<tstamp/>
		<unzip dest="${it.dir}" overwrite="false"
			src="${it.dir}/elasticsearch-${elasticsearch.version}.zip"/>
	</target>

	<macrodef name="read-pid">
		<sequential>
			<loadfile failonerror="false" property="es.pid" srcFile="${es.pid.file}">
				<filterchain>
					<striplinebreaks/>
				</filterchain>
			</loadfile>
		</sequential>
	</macrodef>

	<target depends="setup" description="Start Elasticsearch" name="start">
		<echo message="Starting Elasticsearch ${elasticsearch.version}"/>
		<exec dir="${es.dir}" executable="cmd" failonerror="true" osfamily="windows">
			<arg value="/c"/>
			<arg value="start"/>
			<arg value="/b"/>
			<arg value="bin\elasticsearch.bat"/>
			<arg value="-p"/>
			<arg value="pid"/>
		</exec>
		<exec dir="${es.dir}" executable="bash" failonerror="true" osfamily="unix">
			<arg value="bin/elasticsearch"/>
			<arg value="-d"/>
			<arg value="-p"/>
			<arg value="pid"/>
		</exec>
		<waitfor checkevery="10" checkeveryunit="second" maxwait="1" maxwaitunit="minute">
			<http
				url="http://localhost:9200/_cluster/health?wait_for_status=yellow&amp;timeout=5s"/>
		</waitfor>
		<local name="es.pid"/>
		<read-pid/>
		<echo message="Started Elasticsearch with PID ${es.pid}"/>
	</target>

	<target description="Stop Elasticsearch" if="${es.pid.file.exists}" name="stop">
		<local name="es.pid"/>
		<read-pid/>
		<echo message="Stopping Elasticsearch with PID ${es.pid}"/>
		<exec dir="${es.dir}" executable="taskkill" failonerror="true" osfamily="windows">
			<arg value="/F"/>
			<arg value="/pid"/>
			<arg value="${es.pid}"/>
		</exec>
		<exec dir="${es.dir}" executable="kill" failonerror="true" osfamily="unix">
			<arg value="-SIGTERM"/>
			<arg value="${es.pid}"/>
		</exec>
		<echo message="Stopped Elasticsearch"/>
	</target>
</project>